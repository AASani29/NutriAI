generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model User {
  id                  String               @id @default(uuid())
  clerkId             String               @unique
  email               String?              @unique
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  isDeleted           Boolean              @default(false)
  deletedAt           DateTime?
  aiInsights          AiInsight[]
  auditLogs           AuditLog[]
  chatSessions        ChatSession[]
  consumptions        ConsumptionLog[]     @relation("UserConsumptionLogs")
  consumptionPatterns ConsumptionPattern[]
  files               File[]               @relation("UserFiles")
  fitnessLogs         FitnessLog[]
  foodItemsCreated    FoodItem[]           @relation("CreatedFoodItems")
  foodListings        FoodListing[]        @relation("UserListings")
  hydrationLogs       HydrationLog[]
  inventoriesCreated  Inventory[]          @relation("CreatedInventories")
  inventoryItemsAdded InventoryItem[]      @relation("AddedInventoryItems")
  addedMembers        InventoryMember[]    @relation("AddedInventoryMembers")
  inventoryMembers    InventoryMember[]    @relation("UserInventoryMembers")
  mealPlans           MealPlan[]
  resourcesCreated    Resource[]           @relation("CreatedResources")
  sdgAchievements     SdgAchievement[]
  sdgScores           SdgScore[]
  sharingLogs         SharingLog[]         @relation("UserSharingLogs")
  profile             UserProfile?
  healthMemories      UserHealthMemory[]
}

model HydrationLog {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  amount    Float    @default(0)
  goal      Float    @default(2.5)
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
}

model FitnessLog {
  id             String   @id @default(uuid())
  userId         String
  date           DateTime
  weight         Float?
  steps          Int      @default(0)
  caloriesBurned Float    @default(0)
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
}

model UserProfile {
  id                String    @id @default(uuid())
  userId            String    @unique
  fullName          String?
  dietaryPreference String?
  location          String?
  budgetRange       Float?
  height            Float?
  weight            Float?
  weightPreference  String?
  allergies         String?
  healthConditions  String?
  latitude          Float?
  longitude         Float?
  proteinGoal       Float?
  carbGoal          Float?
  fatGoal           Float?
  energyGoal        Float?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  isDeleted         Boolean   @default(false)
  deletedAt         DateTime?
  user              User      @relation(fields: [userId], references: [id])
}

model FoodItem {
  id                    String            @id @default(uuid())
  name                  String
  unit                  String?
  category              String?
  typicalExpirationDays Int?
  sampleCostPerUnit     Float?
  description           String?
  createdById           String?
  nutritionPerUnit      Json?
  nutritionUnit         String?
  nutritionBasis        Float?
  basePrice             Float?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  isDeleted             Boolean           @default(false)
  deletedAt             DateTime?
  consumptionLogs       ConsumptionLog[]  @relation("FoodItemConsumptions")
  files                 File[]            @relation("FoodItemFiles")
  createdBy             User?             @relation("CreatedFoodItems", fields: [createdById], references: [id])
  foodSafetyAlerts      FoodSafetyAlert[] @relation("FoodItemAlerts")
  inventoryItems        InventoryItem[]
}

model Inventory {
  id          String            @id @default(uuid())
  name        String
  description String?
  createdById String?
  isPrivate   Boolean           @default(true)
  isArchived  Boolean           @default(false)
  archivedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  isDeleted   Boolean           @default(false)
  deletedAt   DateTime?
  consumption ConsumptionLog[]  @relation("InventoryConsumptions")
  files       File[]            @relation("InventoryFiles")
  createdBy   User?             @relation("CreatedInventories", fields: [createdById], references: [id])
  items       InventoryItem[]   @relation("InventoryItems")
  members     InventoryMember[] @relation("InventoryMembers")
}

model InventoryMember {
  id              String           @id @default(uuid())
  inventoryId     String
  userId          String?
  memberName      String?
  role            String
  joinedAt        DateTime         @default(now())
  addedById       String?
  isDeleted       Boolean          @default(false)
  deletedAt       DateTime?
  consumptionLogs ConsumptionLog[] @relation("MemberConsumptions")
  addedBy         User?            @relation("AddedInventoryMembers", fields: [addedById], references: [id])
  inventory       Inventory        @relation("InventoryMembers", fields: [inventoryId], references: [id])
  user            User?            @relation("UserInventoryMembers", fields: [userId], references: [id])
}

model InventoryItem {
  id               String            @id @default(uuid())
  inventoryId      String
  foodItemId       String?
  customName       String?
  quantity         Float             @default(0)
  unit             String?
  addedAt          DateTime          @default(now())
  expiryDate       DateTime?
  removed          Boolean           @default(false)
  notes            String?
  addedById        String?
  updatedAt        DateTime          @updatedAt
  isDeleted        Boolean           @default(false)
  deletedAt        DateTime?
  consumptionLogs  ConsumptionLog[]  @relation("InventoryItemConsumptions")
  expirationRisk   ExpirationRisk?
  files            File[]            @relation("InventoryItemFiles")
  foodListings     FoodListing[]     @relation("FoodListings")
  foodSafetyAlerts FoodSafetyAlert[] @relation("InventoryItemAlerts")
  addedBy          User?             @relation("AddedInventoryItems", fields: [addedById], references: [id])
  foodItem         FoodItem?         @relation(fields: [foodItemId], references: [id])
  inventory        Inventory         @relation("InventoryItems", fields: [inventoryId], references: [id])
}

model ConsumptionLog {
  id              String           @id @default(uuid())
  inventoryId     String?
  inventoryItemId String?
  consumedById    String?
  foodItemId      String?
  itemName        String
  quantity        Float
  unit            String?
  calories        Float?
  protein         Float?
  carbohydrates   Float?
  fat             Float?
  fiber           Float?
  sugar           Float?
  sodium          Float?
  cost            Float?
  consumedAt      DateTime         @default(now())
  notes           String?
  isDeleted       Boolean          @default(false)
  deletedAt       DateTime?
  userId          String?
  consumedBy      InventoryMember? @relation("MemberConsumptions", fields: [consumedById], references: [id])
  foodItem        FoodItem?        @relation("FoodItemConsumptions", fields: [foodItemId], references: [id])
  inventory       Inventory?       @relation("InventoryConsumptions", fields: [inventoryId], references: [id])
  inventoryItem   InventoryItem?   @relation("InventoryItemConsumptions", fields: [inventoryItemId], references: [id])
  user            User?            @relation("UserConsumptionLogs", fields: [userId], references: [id])
}

model Resource {
  id          String                  @id @default(uuid())
  title       String
  description String?
  url         String?
  type        ResourceType
  createdById String?
  isPublic    Boolean                 @default(true)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  isDeleted   Boolean                 @default(false)
  deletedAt   DateTime?
  createdBy   User?                   @relation("CreatedResources", fields: [createdById], references: [id])
  tags        ResourceTagOnResource[]
}

model ResourceTag {
  id        String                  @id @default(uuid())
  tag       String                  @unique
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  isDeleted Boolean                 @default(false)
  deletedAt DateTime?
  resources ResourceTagOnResource[]
}

model ResourceTagOnResource {
  resourceId String
  tagId      String
  createdAt  DateTime    @default(now())
  resource   Resource    @relation(fields: [resourceId], references: [id])
  tag        ResourceTag @relation(fields: [tagId], references: [id])

  @@id([resourceId, tagId])
}

model File {
  id              String         @id @default(uuid())
  userId          String?
  url             String
  filename        String?
  mimeType        String?
  size            Int?
  foodItemId      String?
  inventoryId     String?
  inventoryItemId String?
  createdAt       DateTime       @default(now())
  isDeleted       Boolean        @default(false)
  deletedAt       DateTime?
  foodItem        FoodItem?      @relation("FoodItemFiles", fields: [foodItemId], references: [id])
  inventory       Inventory?     @relation("InventoryFiles", fields: [inventoryId], references: [id])
  inventoryItem   InventoryItem? @relation("InventoryItemFiles", fields: [inventoryItemId], references: [id])
  user            User?          @relation("UserFiles", fields: [userId], references: [id])
}

model ConsumptionPattern {
  id             String   @id @default(cuid())
  userId         String
  weekStartDate  DateTime
  category       String
  avgQuantity    Float
  trendDirection String
  patternType    String?
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id])
}

model AiInsight {
  id          String   @id @default(cuid())
  userId      String
  insightType String
  data        Json
  generatedAt DateTime @default(now())
  expiresAt   DateTime
  user        User     @relation(fields: [userId], references: [id])
}

model ExpirationRisk {
  id                 String        @id @default(cuid())
  inventoryItemId    String        @unique
  riskScore          Int
  riskFactors        Json
  predictedWasteDate DateTime?
  alertSent          Boolean       @default(false)
  createdAt          DateTime      @default(now())
  inventoryItem      InventoryItem @relation(fields: [inventoryItemId], references: [id])
}

model MealPlan {
  id               String   @id @default(cuid())
  userId           String
  weekStartDate    DateTime
  budget           Float
  meals            Json
  shoppingList     Json
  totalCost        Float
  nutritionSummary Json?
  status           String   @default("active")
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id])
}

model ChatSession {
  id           String        @id @default(cuid())
  userId       String
  mode         String        @default("ask")
  startedAt    DateTime      @default(now())
  lastActivity DateTime      @default(now())
  messages     ChatMessage[]
  user         User          @relation(fields: [userId], references: [id])
}

model ChatMessage {
  id          String      @id @default(cuid())
  sessionId   String
  role        String
  content     String
  contextData Json?
  createdAt   DateTime    @default(now())
  session     ChatSession @relation(fields: [sessionId], references: [id])
}

model SdgScore {
  id                  String   @id @default(cuid())
  userId              String
  weekStartDate       DateTime
  wasteReductionScore Int
  nutritionScore      Int
  budgetScore         Int
  sustainabilityScore Int
  totalScore          Int
  insights            Json
  recommendations     Json
  createdAt           DateTime @default(now())
  user                User     @relation(fields: [userId], references: [id])

  @@unique([userId, weekStartDate])
}

model SdgAchievement {
  id              String   @id @default(cuid())
  userId          String
  achievementType String
  title           String
  description     String
  unlockedAt      DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])
}

model FoodListing {
  id              String        @id @default(uuid())
  inventoryItemId String
  listerId        String
  title           String
  description     String?
  quantity        Float
  unit            String?
  pickupLocation  String?
  latitude        Float?
  longitude       Float?
  availableUntil  DateTime?
  status          ListingStatus @default(AVAILABLE)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  isDeleted       Boolean       @default(false)
  deletedAt       DateTime?
  inventoryItem   InventoryItem @relation("FoodListings", fields: [inventoryItemId], references: [id])
  lister          User          @relation("UserListings", fields: [listerId], references: [id])
  sharingLogs     SharingLog[]  @relation("ListingSharingLogs")
}

model SharingLog {
  id              String      @id @default(uuid())
  listingId       String
  claimerId       String?
  claimerName     String?
  claimedAt       DateTime?
  completedAt     DateTime?
  notes           String?
  quantityClaimed Float?
  status          String      @default("CLAIMED")
  createdAt       DateTime    @default(now())
  isDeleted       Boolean     @default(false)
  deletedAt       DateTime?
  claimer         User?       @relation("UserSharingLogs", fields: [claimerId], references: [id])
  listing         FoodListing @relation("ListingSharingLogs", fields: [listingId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  details   Json
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model FoodSafetyAlert {
  id              String         @id @default(uuid())
  foodItemId      String?
  inventoryItemId String?
  alertType       String
  severity        String
  message         String
  createdAt       DateTime       @default(now())
  isResolved      Boolean        @default(false)
  resolvedAt      DateTime?
  foodItem        FoodItem?      @relation("FoodItemAlerts", fields: [foodItemId], references: [id])
  inventoryItem   InventoryItem? @relation("InventoryItemAlerts", fields: [inventoryItemId], references: [id])
}

model HealthKnowledge {
  id        String                 @id @default(uuid())
  content   String
  category  String
  tags      String[]
  metadata  Json?
  embedding Unsupported("vector")?
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  @@map("health_knowledge")
}

model UserHealthMemory {
  id        String                 @id @default(uuid())
  userId    String
  content   String
  source    String
  embedding Unsupported("vector")?
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  user      User                   @relation(fields: [userId], references: [id])

  @@map("user_health_memory")
}

model Recipe {
  id           String   @id @default(uuid())
  name         String
  description  String?
  cuisine      String?
  prepTime     Int?
  cookTime     Int?
  servings     Int?
  ingredients  Json
  instructions Json
  nutrition    Json?
  sourceUrl    String?
  sourceType   String   @default("AI_SCOUT")
  externalId   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([name])
}

enum ResourceType {
  Article
  Video
}

enum ListingStatus {
  AVAILABLE
  CLAIMED
  COMPLETED
  CANCELLED
}
